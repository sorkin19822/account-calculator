# Калькулятор оптимального распределения средств

Веб-приложение для расчета и управления распределением средств по счетам при пополнении.

## Возможности

- **Динамический калькулятор** с интерактивной таблицей
- **Распределение средств** с приоритетом основного счета
- **Поддержка замороженных счетов** (не участвуют в распределении)
- **История операций** с детализацией транзакций
- **REST API** для интеграции с другими системами
- **Редактирование данных** счетов в реальном времени

## Технологии

- **Backend**: PHP 8.2, MySQL 8.0
- **Frontend**: HTML5, Bootstrap 5, Vanilla JavaScript
- **Контейнеризация**: Docker, Docker Compose

## Быстрый запуск

### Предварительные требования

- Docker и Docker Compose
- Порты 8080 и 3306 должны быть свободны

### Установка и запуск

1. **Клонируйте проект:**
   ```bash
   git clone <repository-url>
   cd account-calculator
   ```

2. **Запустите приложение:**
   ```bash
   docker-compose up -d
   ```

3. **Дождитесь инициализации базы данных** (1-2 минуты)

4. **Откройте приложение:**
   ```
   http://localhost:8080
   ```

### Остановка приложения

```bash
docker-compose down
```

### Полная очистка данных

```bash
docker-compose down -v
```

## Структура проекта

```
/
├── Dockerfile              # Конфигурация PHP-контейнера
├── docker-compose.yml      # Настройка сервисов
├── apache.conf             # Конфигурация Apache
├── init.sql               # Инициализация БД и тестовые данные
├── README.md              # Документация
└── src/                   # Исходный код приложения
    ├── index.php          # Главная страница
    ├── config/
    │   └── database.php   # Конфигурация БД
    ├── models/
    │   ├── Account.php    # Модель счетов
    │   └── Transaction.php # Модель транзакций
    ├── services/
    │   └── CalculatorService.php # Бизнес-логика
    └── api/
        └── index.php      # API endpoints
```

## API Endpoints

### GET endpoints

- `GET /api/?action=accounts` - Получить все счета
- `GET /api/?action=transactions&limit=50` - История операций
- `GET /api/?action=calculate&amount=100&target=715044` - Расчет распределения

### POST endpoints

- `POST /api/?action=deposit` - Выполнить пополнение
  ```json
  {
    "amount": 100.00,
    "target": "715044"  // optional
  }
  ```

- `POST /api/?action=update_account` - Обновить данные счета
  ```json
  {
    "account_number": "715044",
    "monthly_fee": 200.00,
    "balance": -50.00
  }
  ```

## Бизнес-логика

### Алгоритм распределения

1. **При пополнении конкретного счета** - вся сумма зачисляется на указанный счет
2. **При пополнении основного счета** (с распределением):
    - Сначала покрываются отрицательные балансы всех незамороженных счетов
    - Оставшаяся сумма полностью зачисляется на основной счет
    - Замороженные счета не участвуют в распределении

### Типы счетов

- **Основной счет** (`is_main = 1`) - высший приоритет, получает остаток средств
- **Дополнительные счета** (`is_main = 0`) - участвуют только в покрытии долгов
- **Замороженные счета** (`is_frozen = 1`) - не участвуют в операциях

### Статусы счетов

- **Активен** - баланс >= 0
- **Неактивен** - баланс < 0
- **Заморожен** - счет заморожен

## База данных

### Таблица accounts

| Поле | Тип | Описание |
|------|-----|----------|
| account_number | VARCHAR(20) | Номер счета (уникальный) |
| monthly_fee | DECIMAL(10,2) | Абонентская плата |
| balance | DECIMAL(10,2) | Текущий баланс |
| is_main | BOOLEAN | Основной счет |
| is_frozen | BOOLEAN | Заморожен |

### Таблица transactions

| Поле | Тип | Описание |
|------|-----|----------|
| account_number | VARCHAR(20) | Номер счета |
| transaction_type | ENUM | Тип операции |
| amount | DECIMAL(10,2) | Сумма |
| balance_before | DECIMAL(10,2) | Баланс до |
| balance_after | DECIMAL(10,2) | Баланс после |
| description | TEXT | Описание |

## Тестовые данные

При первом запуске создаются тестовые счета:

| Л/С | Абонплата | Баланс | Тип |
|-----|-----------|--------|-----|
| 715044 | 200 | -50 | Основной |
| 71504401 | 150 | 100 | Дополнительный |
| 71504402 | 100 | -100 | Дополнительный |
| 71504403 | 0 | 50 | Заморожен |
| 71504404 | 150 | 150 | Дополнительный |

## Настройка окружения

### Переменные окружения

Можно изменить в `docker-compose.yml`:

```yaml
environment:
  - DB_HOST=db
  - DB_NAME=accounts_db
  - DB_USER=root
  - DB_PASSWORD=rootpassword
```

### Порты

- **Веб-приложение**: localhost:8080
- **MySQL**: localhost:3306

## Разработка

### Подключение к БД

```bash
# Через Docker
docker exec -it <mysql_container_id> mysql -u root -p accounts_db

# Или напрямую
mysql -h localhost -P 3306 -u root -p accounts_db
```

### Логи приложения

```bash
# Логи веб-сервера
docker-compose logs web

# Логи БД
docker-compose logs db
```

### Перезапуск после изменений

```bash
# Только веб-сервер
docker-compose restart web

# Полная пересборка
docker-compose up --build
```

## Возможные проблемы

1. **Порт 8080 занят** - измените порт в docker-compose.yml
2. **База данных не инициализируется** - проверьте логи DB контейнера
3. **Ошибки подключения к БД** - убедитесь что контейнер БД запущен

## Лицензия

MIT License